<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Jobs - CRUD API</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 30px;
      }

      h1 {
        color: #667eea;
        margin-bottom: 30px;
        text-align: center;
        font-size: 2.5em;
      }

      .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 14px;
      }

      .jobs-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .jobs-table th {
        background: #667eea;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      .jobs-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e5e7eb;
      }

      .jobs-table tr:hover {
        background: #f9fafb;
      }

      .jobs-table tr:last-child td {
        border-bottom: none;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
      }

      .status-active {
        background: #10b981;
        color: white;
      }

      .status-paused {
        background: #f59e0b;
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        overflow-y: auto;
      }

      .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        font-size: 1.8em;
        color: #667eea;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 2em;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-close:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
      }

      label span {
        color: #ef4444;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
        font-family: inherit;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
      }

      .message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .message.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }

      .message.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }

      .message.show {
        display: block;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìß Qu·∫£n L√Ω Jobs - CRUD API</h1>

      <div id="message" class="message"></div>

      <div class="controls">
        <button class="btn-primary" onclick="openAddModal()">
          ‚ûï Th√™m Job M·ªõi
        </button>
        <button class="btn-success" onclick="loadJobs()">
          üîÑ T·∫£i L·∫°i
        </button>
      </div>

      <div id="loading" class="loading" style="display: none;">
        ƒêang t·∫£i d·ªØ li·ªáu...
      </div>

      <table class="jobs-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>T√™n Job</th>
            <th>Email G·ª≠i</th>
            <th>S·ªë Email Nh·∫≠n</th>
            <th>L·ªãch</th>
            <th>Tr·∫°ng Th√°i</th>
            <th>Ng√†y T·∫°o</th>
            <th>Thao T√°c</th>
          </tr>
        </thead>
        <tbody id="jobsTableBody">
          <tr>
            <td colspan="8" class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <h3>Ch∆∞a c√≥ d·ªØ li·ªáu</h3>
              <p>Nh·∫•n "T·∫£i L·∫°i" ƒë·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ database</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Modal Th√™m/S·ª≠a Job -->
    <div class="modal" id="jobModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Th√™m Job M·ªõi</h2>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <form id="jobForm">
          <div class="form-group">
            <label>T√™n Job <span>*</span></label>
            <input
              type="text"
              id="jobName"
              required
              placeholder="VD: G·ª≠i mail kh√°ch h√†ng VIP"
            />
          </div>

          <div class="form-group">
            <label>Chrome Profile</label>
            <input
              type="text"
              id="chromeProfile"
              placeholder="VD: Default ho·∫∑c Profile 1"
            />
          </div>

          <div class="form-group">
            <label>Email G·ª≠i <span>*</span></label>
            <input
              type="email"
              id="emailFrom"
              required
              placeholder="example@gmail.com"
            />
          </div>

          <div class="form-group">
            <label>Danh S√°ch Email Nh·∫≠n <span>*</span></label>
            <textarea
              id="emailTo"
              required
              placeholder="Nh·∫≠p email, c√°ch nhau b·ªüi d·∫•u ph·∫©y ho·∫∑c xu·ªëng d√≤ng&#10;VD: abc@gmail.com, xyz@gmail.com"
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Ti√™u ƒê·ªÅ Email <span>*</span></label>
            <input
              type="text"
              id="emailSubject"
              required
              placeholder="VD: Th√¥ng b√°o khuy·∫øn m√£i"
            />
          </div>

          <div class="form-group">
            <label>N·ªôi Dung Email <span>*</span></label>
            <textarea
              id="emailBody"
              required
              placeholder="Nh·∫≠p n·ªôi dung email..."
              rows="6"
            ></textarea>
          </div>

          <div class="form-group">
            <label>L·ªãch G·ª≠i</label>
            <select id="schedule">
              <option value="manual">G·ª≠i Th·ªß C√¥ng</option>
              <option value="daily">H√†ng Ng√†y</option>
              <option value="weekly">H√†ng Tu·∫ßn</option>
              <option value="monthly">H√†ng Th√°ng</option>
            </select>
          </div>

          <div class="form-group">
            <label>Th·ªùi Gian G·ª≠i</label>
            <input type="time" id="scheduleTime" value="09:00" />
          </div>

          <div class="form-group">
            <label>Ghi Ch√∫</label>
            <textarea
              id="notes"
              placeholder="Th√™m ghi ch√∫ v·ªÅ job n√†y..."
              rows="3"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Tr·∫°ng Th√°i</label>
            <select id="status">
              <option value="active">Ho·∫°t ƒê·ªông</option>
              <option value="paused">T·∫°m D·ª´ng</option>
            </select>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-danger" onclick="closeModal()">
              H·ªßy
            </button>
            <button type="submit" class="btn-primary">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:3000/api";
      let editingJobId = null;

      // Hi·ªÉn th·ªã th√¥ng b√°o
      function showMessage(message, type = "success") {
        const messageEl = document.getElementById("message");
        messageEl.textContent = message;
        messageEl.className = `message ${type} show`;
        setTimeout(() => {
          messageEl.classList.remove("show");
        }, 5000);
      }

      // T·∫£i danh s√°ch jobs
      async function loadJobs() {
        const loadingEl = document.getElementById("loading");
        const tableBody = document.getElementById("jobsTableBody");
        
        loadingEl.style.display = "block";
        tableBody.innerHTML = "";

        try {
          const response = await fetch(`${API_BASE_URL}/jobs`);
          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "L·ªói khi t·∫£i d·ªØ li·ªáu");
          }

          if (result.data.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="8" class="empty-state">
                  <div class="empty-state-icon">üì≠</div>
                  <h3>Ch∆∞a c√≥ job n√†o</h3>
                  <p>Nh·∫•n "Th√™m Job M·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                </td>
              </tr>
            `;
          } else {
            tableBody.innerHTML = result.data
              .map(
                (job) => `
              <tr>
                <td>${job.id}</td>
                <td>${escapeHtml(job.name)}</td>
                <td>${escapeHtml(job.email_from)}</td>
                <td>${Array.isArray(job.email_to) ? job.email_to.length : 0}</td>
                <td>${getScheduleText(job.schedule)}</td>
                <td>
                  <span class="status-badge ${
                    job.status === "active" ? "status-active" : "status-paused"
                  }">
                    ${job.status === "active" ? "Ho·∫°t ƒê·ªông" : "T·∫°m D·ª´ng"}
                  </span>
                </td>
                <td>${new Date(job.created_at).toLocaleString("vi-VN")}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-primary btn-small" onclick="editJob(${job.id})">
                      ‚úè S·ª≠a
                    </button>
                    <button class="btn-danger btn-small" onclick="deleteJob(${job.id})">
                      üóë X√≥a
                    </button>
                  </div>
                </td>
              </tr>
            `
              )
              .join("");
          }

          showMessage(`ƒê√£ t·∫£i ${result.data.length} job th√†nh c√¥ng`);
        } catch (error) {
          console.error("L·ªói khi t·∫£i jobs:", error);
          tableBody.innerHTML = `
            <tr>
              <td colspan="8" class="empty-state">
                <div class="empty-state-icon">‚ùå</div>
                <h3>L·ªói khi t·∫£i d·ªØ li·ªáu</h3>
                <p>${error.message}</p>
              </td>
            </tr>
          `;
          showMessage(`L·ªói: ${error.message}`, "error");
        } finally {
          loadingEl.style.display = "none";
        }
      }

      // Escape HTML ƒë·ªÉ tr√°nh XSS
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // L·∫•y text cho schedule
      function getScheduleText(schedule) {
        const texts = {
          manual: "Th·ªß c√¥ng",
          daily: "H√†ng ng√†y",
          weekly: "H√†ng tu·∫ßn",
          monthly: "H√†ng th√°ng",
        };
        return texts[schedule] || schedule;
      }

      // M·ªü modal th√™m m·ªõi
      function openAddModal() {
        editingJobId = null;
        document.getElementById("modalTitle").textContent = "Th√™m Job M·ªõi";
        document.getElementById("jobForm").reset();
        document.getElementById("scheduleTime").value = "09:00";
        document.getElementById("status").value = "active";
        document.getElementById("jobModal").classList.add("active");
      }

      // ƒê√≥ng modal
      function closeModal() {
        document.getElementById("jobModal").classList.remove("active");
        editingJobId = null;
      }

      // S·ª≠a job
      async function editJob(id) {
        try {
          const response = await fetch(`${API_BASE_URL}/jobs/${id}`);
          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "Kh√¥ng t√¨m th·∫•y job");
          }

          const job = result.data;
          editingJobId = id;

          document.getElementById("modalTitle").textContent = "Ch·ªânh S·ª≠a Job";
          document.getElementById("jobName").value = job.name || "";
          document.getElementById("chromeProfile").value = job.chrome_profile || "";
          document.getElementById("emailFrom").value = job.email_from || "";
          document.getElementById("emailTo").value = Array.isArray(job.email_to)
            ? job.email_to.join(", ")
            : job.email_to || "";
          document.getElementById("emailSubject").value = job.email_subject || "";
          document.getElementById("emailBody").value = job.email_body || "";
          document.getElementById("schedule").value = job.schedule || "manual";
          document.getElementById("scheduleTime").value = job.schedule_time
            ? job.schedule_time.substring(0, 5)
            : "09:00";
          document.getElementById("notes").value = job.notes || "";
          document.getElementById("status").value = job.status || "active";

          document.getElementById("jobModal").classList.add("active");
        } catch (error) {
          console.error("L·ªói khi t·∫£i job:", error);
          showMessage(`L·ªói: ${error.message}`, "error");
        }
      }

      // X√≥a job
      async function deleteJob(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a job n√†y?")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/jobs/${id}`, {
            method: "DELETE",
          });
          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "L·ªói khi x√≥a job");
          }

          showMessage("ƒê√£ x√≥a job th√†nh c√¥ng");
          loadJobs();
        } catch (error) {
          console.error("L·ªói khi x√≥a job:", error);
          showMessage(`L·ªói: ${error.message}`, "error");
        }
      }

      // X·ª≠ l√Ω submit form
      document.getElementById("jobForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const emailToText = document.getElementById("emailTo").value;
        const emailToArray = emailToText
          .split(/[,\n]/)
          .map((email) => email.trim())
          .filter((email) => email.length > 0);

        const jobData = {
          name: document.getElementById("jobName").value,
          chrome_profile: document.getElementById("chromeProfile").value || null,
          email_from: document.getElementById("emailFrom").value,
          email_to: emailToArray,
          email_subject: document.getElementById("emailSubject").value,
          email_body: document.getElementById("emailBody").value,
          schedule: document.getElementById("schedule").value,
          schedule_time: document.getElementById("scheduleTime").value + ":00",
          notes: document.getElementById("notes").value || null,
          status: document.getElementById("status").value,
        };

        try {
          let response;
          if (editingJobId) {
            // C·∫≠p nh·∫≠t
            response = await fetch(`${API_BASE_URL}/jobs/${editingJobId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(jobData),
            });
          } else {
            // T·∫°o m·ªõi
            response = await fetch(`${API_BASE_URL}/jobs`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(jobData),
            });
          }

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.error || "L·ªói khi l∆∞u job");
          }

          showMessage(
            editingJobId ? "ƒê√£ c·∫≠p nh·∫≠t job th√†nh c√¥ng" : "ƒê√£ t·∫°o job th√†nh c√¥ng"
          );
          closeModal();
          loadJobs();
        } catch (error) {
          console.error("L·ªói khi l∆∞u job:", error);
          showMessage(`L·ªói: ${error.message}`, "error");
        }
      });

      // ƒê√≥ng modal khi click b√™n ngo√†i
      document.getElementById("jobModal").addEventListener("click", (e) => {
        if (e.target.id === "jobModal") {
          closeModal();
        }
      });

      // T·∫£i jobs khi trang ƒë∆∞·ª£c t·∫£i
      loadJobs();
    </script>
  </body>
</html>

